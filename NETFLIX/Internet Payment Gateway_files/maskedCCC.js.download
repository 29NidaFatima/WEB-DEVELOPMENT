(function() {

	window.MaskedCCC = window.MaskedCCC || {};

	// register methods for desktop and mobile view
	window.MaskedCCC.maskCCCOnChange = maskCCCOnChange;
	window.MaskedCCC.maskCCC = maskCCC;
	window.MaskedCCC.moveCaretToTheEnd = moveCaretToTheEnd;

	function maskCCCOnChange(e) {
		moveCaretToTheEnd("cvm_masked");
		var $ccc_hidden_field = $("#cvm");
		var $ccc_masked_field = $("#cvm_masked");
		var ccc_hidden = $ccc_hidden_field.val();
		var ccc_masked = $ccc_masked_field.val();
		var length_masked = ccc_masked.length;
		if (e.which == 8 || e.which == 46) { // backspace (8) or delete (46)
			$ccc_hidden_field.val(ccc_hidden.substr(0, length_masked));
			return;
		}
		var ccc_new_chars = ccc_masked.replace(/[*]+/g, "");
		if (ccc_new_chars === "") {
			return;
		}
		var stars = ccc_masked.replace(/./g, "*");
		ccc_hidden = ccc_hidden + ccc_new_chars;
		var length_hidden = ccc_hidden.length;
		if (length_masked < length_hidden) {
			// takes substring from the end of the string
			ccc_hidden = ccc_hidden.substr(-1 * (length_masked), length_masked);
		}
		$ccc_hidden_field.val(ccc_hidden);
		$ccc_masked_field.val(stars);
	}

	function maskCCC() {
		var ccc_hidden = $("#cvm").val();
		var stars = ccc_hidden.replace(/./g, "*");
		$("#cvm_masked").val(stars);
	}
	/**
	 * Forces the Caret to the end of the string in input field.
	 */
	function moveCaretToTheEnd(fieldID) {
		var ccc_masked_input = document.getElementById(fieldID);
		var ccc_masked_length = ccc_masked_input.value.length;
		if ('selectionStart' in ccc_masked_input) {
			// allow position at the end or text selection (ending at the end)
			var isTextSelectionUntillTheEnd = ccc_masked_input.selectionEnd == ccc_masked_length && ccc_masked_input.selectionStart <= ccc_masked_length;
			if (!isTextSelectionUntillTheEnd) {
				ccc_masked_input.selectionStart = ccc_masked_length;
				ccc_masked_input.selectionEnd = ccc_masked_length;
				ccc_masked_input.focus();
			}
		} else { // IE8 or less
			var inputRange = ccc_masked_input.createTextRange();
			inputRange.moveStart("character", ccc_masked_length);
			inputRange.collapse();
			inputRange.moveEnd("character", ccc_masked_length);
			inputRange.select();
		}
	}
})();